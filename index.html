<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>AR Video ‚Äî Ch·ªß ƒë·ªÅ A80 Qu·ªëc kh√°nh 2/9</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <!-- jsQR fallback cho qu√©t QR -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: transparent !important;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    a-scene, canvas { background: transparent !important; }

    video#mindar-video {
      position: fixed !important; inset: 0 !important;
      width: 100vw !important; height: 100vh !important;
      object-fit: cover !important; z-index: -1 !important;
      filter: saturate(1.05) contrast(1.05);
    }

    :root { --red:#C8102E; --bright-red:#e11d2f; --gold:#FFD700; --glass:rgba(0,0,0,.35); }

    .banner {
      position: fixed; left: 12px; right: 12px; top: 12px; z-index: 10;
      display: flex; align-items: center; gap: 10px;
      background: linear-gradient(135deg, var(--red), var(--bright-red));
      color: #fff; padding: 10px 14px; border-radius: 16px;
      box-shadow: 0 12px 30px rgba(200,16,46,.35), inset 0 0 0 2px rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
    }
    .banner .star {
      width: 28px; height: 28px; background: var(--gold);
      clip-path: polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.25));
    }
    .banner .title { font-weight: 900; letter-spacing: .2px; font-size: 16px; text-shadow: 0 1px 0 rgba(0,0,0,.25); }
    .banner .sub { margin-left:auto; font-weight:700; background:rgba(255,255,255,.15); padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.2); }

    .tip {
      position: fixed; left: 50%; transform: translateX(-50%); top: 64px; z-index: 10;
      color:#fff; font-weight:700; background: var(--glass);
      padding: 8px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.2);
      text-shadow: 0 1px 0 rgba(0,0,0,.35);
    }

    #ui {
      position: fixed; left: 0; right: 0; bottom: 14px; z-index: 10;
      display: flex; justify-content: center; gap: 10px; padding: 0 12px;
    }
    .btn {
      appearance: none; border: 0; cursor: pointer; padding: 10px 14px; border-radius: 999px;
      font-weight: 800; box-shadow: 0 10px 24px rgba(0,0,0,.25), inset 0 0 0 2px rgba(255,255,255,.22);
      backdrop-filter: blur(8px); background: linear-gradient(135deg, var(--gold), #f6c105); color: #7a5200;
    }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }

    /* Bottom sheet m·ªü URL sau khi qu√©t */
    #qrSheet {
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 9998; display: none;
      background: rgba(20,20,20,.9); color: #fff; border-top-left-radius: 16px; border-top-right-radius: 16px;
      box-shadow: 0 -10px 30px rgba(0,0,0,.35); padding: 14px;
    }
    #qrURL {
      word-break: break-all; font-size: 14px; opacity: .9; margin-bottom: 10px;
    }
    #qrActions {
      display: flex; gap: 10px; justify-content: space-between; align-items: center;
    }
    #openLink, #dismissSheet {
      appearance: none; border: 0; cursor: pointer; padding: 10px 14px; border-radius: 999px; font-weight: 800;
    }
    #openLink {
      background: linear-gradient(135deg, var(--gold), #f6c105); color:#7a5200; text-decoration: none; display: inline-block;
    }
    #dismissSheet {
      background: rgba(255,255,255,.12); color:#fff;
    }
  </style>
</head>

<body>

  <div class="banner">
    <div class="star"></div>
    <div class="title">M·ª´ng Qu·ªëc kh√°nh 2/9</div>
    <div class="sub">A80 Fest</div>
  </div>

  <div class="tip" id="tip">Nh·∫•n n√∫t ƒë·ªÉ chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô AR/QR</div>

  <div id="ui">
    <button class="btn" id="modeBtn">üîÅ Ch·∫ø ƒë·ªô: AR</button>
    <button class="btn" id="unlockBtn">üîä B·∫≠t ti·∫øng</button>
  </div>

  <!-- Bottom sheet QR -->
  <div id="qrSheet" role="dialog" aria-modal="true">
    <div id="qrURL"></div>
    <div id="qrActions">
      <a id="openLink" href="#" target="_blank" rel="noopener">üîó M·ªü trong tab m·ªõi</a>
      <button id="dismissSheet">ƒê√≥ng</button>
    </div>
  </div>

  <a-scene mindar-image="imageTargetSrc: ./targets.mind;" vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false" embedded
    renderer="alpha: true; colorManagement: true; physicallyCorrectLights: true">

    <a-assets>
      <!-- Th√™m loop ƒë·ªÉ tr√°nh ƒë·ª©ng ·ªü cu·ªëi -->
      <video id="v0" src="./video1.mp4" preload="auto" loop webkit-playsinline playsinline crossorigin="anonymous"></video>
      <video id="v1" src="./video2.mp4" preload="auto" loop webkit-playsinline playsinline crossorigin="anonymous"></video>
      <video id="v2" src="./video3.mp4" preload="auto" loop webkit-playsinline playsinline crossorigin="anonymous"></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity id="t0" mindar-image-target="targetIndex: 0">
      <a-video src="#v0" width="1" height="0.5625" position="0 0 0"></a-video>
    </a-entity>
    <a-entity id="t1" mindar-image-target="targetIndex: 1">
      <a-video src="#v1" width="1" height="0.5625" position="0 0 0"></a-video>
    </a-entity>
    <a-entity id="t2" mindar-image-target="targetIndex: 2">
      <a-video src="#v2" width="1" height="0.5625" position="0 0 0"></a-video>
    </a-entity>

  </a-scene>

  <script>
    /* ===== C·∫•u h√¨nh video & m·ªü kh√≥a √¢m thanh ===== */
    const vids = Array.from(document.querySelectorAll('video'));
    vids.forEach(v => {
      v.muted = true; // gi·ªØ muted ƒë·ªÉ autoplay kh√¥ng l·ªói
      v.setAttribute('playsinline', '');
      v.setAttribute('webkit-playsinline', '');
      v.volume = 1.0;
    });

    let AUDIO_UNLOCKED = false;
    async function unlockAudio() {
      if (AUDIO_UNLOCKED) return;
      // 1) Resume WebAudio c·ªßa A-Frame (n·∫øu d√πng)
      try {
        const scene = AFRAME.scenes?.[0];
        const ctx = scene?.systems?.sound?.listener?.context;
        if (ctx && ctx.state !== 'running') await ctx.resume();
      } catch (e) {}

      // 2) ‚Äúk√≠ch ho·∫°t‚Äù quy·ªÅn ph√°t ti·∫øng cho t·∫•t c·∫£ video trong 1 gesture
      await Promise.all(vids.map(async v => {
        try {
          v.muted = false;
          await v.play();  // play trong gesture ƒë·ªÉ l·∫•y quy·ªÅn audio
          v.pause();       // kh√¥ng mu·ªën ph√°t ngay ‚Üí pause v√† tua v·ªÅ ƒë·∫ßu
          v.currentTime = 0;
        } catch (e) {}
      }));

      AUDIO_UNLOCKED = true;
      // C·∫≠p nh·∫≠t UI n√∫t
      unlockBtn.textContent = 'üîä ƒê√£ b·∫≠t ti·∫øng';
      unlockBtn.setAttribute('disabled', 'disabled');
    }

    const unlockBtn = document.getElementById('unlockBtn');
    unlockBtn.addEventListener('click', unlockAudio);

    // Ch·∫ø ƒë·ªô: 'AR' ho·∫∑c 'QR'
    window.MODE = 'AR';
    const modeBtn = document.getElementById('modeBtn');
    const tipEl = document.getElementById('tip');
    function updateModeUI() {
      modeBtn.textContent = (window.MODE === 'AR') ? 'üîÅ Ch·∫ø ƒë·ªô: AR' : 'üîÅ Ch·∫ø ƒë·ªô: QR';
      tipEl.textContent = (window.MODE === 'AR')
        ? 'Nh·∫•n n√∫t ƒë·ªÉ qu√©t QR'
        : 'Nh·∫•n n√∫t ƒë·ªÉ v·ªÅ ch·∫ø ƒë·ªô AR';
    }
    updateModeUI();

    modeBtn.addEventListener('click', () => {
      window.MODE = (window.MODE === 'AR') ? 'QR' : 'AR';
      updateModeUI();
      // khi v√†o QR mode: d·ª´ng h·∫øt video
      if (window.MODE === 'QR') vids.forEach(v => { try { v.pause(); } catch {} });
    });

    /* ===== Watchdog: gi·ªØ video kh√¥ng ‚Äúƒë·ª©ng h√¨nh‚Äù ===== */
    function keepAlive(video) {
      let lastT = -1;
      setInterval(() => {
        // ch·ªâ ki·ªÉm tra khi ƒëang ·ªü AR v√† c√≥ target b√°m
        if (window.MODE !== 'AR' || window.activeTargets === 0) return;
        if (video.paused || video.readyState < 2) return;

        const t = video.currentTime;
        if (Math.abs(t - lastT) < 0.001) {
          try {
            if (video.readyState === 0) video.load();
            video.pause();
            video.play().catch(()=>{});
          } catch {}
        }
        lastT = t;
      }, 700);
    }

    /* ===== Theo d√µi marker ===== */
    window.activeTargets = 0;
    function wireTarget(targetSelector, videoSelector) {
      const target = document.querySelector(targetSelector);
      const video = document.querySelector(videoSelector);
      if (!target || !video) return;

      // b·∫≠t watchdog cho t·ª´ng video
      keepAlive(video);

      target.addEventListener('targetFound', async () => {
        window.activeTargets++;
        if (window.MODE === 'AR') {
          try {
            if (video.readyState === 0) video.load();
            if (video.currentTime < 0.01) video.currentTime = 0;
            await video.play().catch(()=>{});
            if (video.paused) { // c·ªë l·∫ßn 2 n·∫øu c·∫ßn
              try { video.pause(); } catch {}
              await video.play().catch(()=>{});
            }
          } catch {}
        }
      });
      target.addEventListener('targetLost', () => {
        window.activeTargets = Math.max(0, window.activeTargets - 1);
        if (!video.paused) video.pause();
      });
    }
    wireTarget('#t0', '#v0');
    wireTarget('#t1', '#v1');
    wireTarget('#t2', '#v2');

    /* ===== Qu√©t QR (d√πng camera MindAR) ===== */
    (async () => {
      function findMindARVideo() {
        // ∆Øu ti√™n ph·∫ßn t·ª≠ c√≥ stream camera th·∫≠t
        const all = Array.from(document.querySelectorAll('video'));
        const withStream = all.find(v => v.srcObject instanceof MediaStream);
        if (withStream) return withStream;

        // MindAR th∆∞·ªùng ƒë·∫∑t id b·∫Øt ƒë·∫ßu b·∫±ng 'mindar'
        const byId = document.querySelector('video#mindar-video')
          || document.querySelector('video#mindar-image-video')
          || all.find(v => (v.id || '').includes('mindar'));
        return byId || null;
      }

      const waitMindARVideo = () => new Promise(res => {
        const tick = () => { const v = findMindARVideo(); v ? res(v) : requestAnimationFrame(tick); }; tick();
      });
      const camVideo = await waitMindARVideo();
      camVideo.setAttribute('playsinline', ''); camVideo.setAttribute('webkit-playsinline', '');
      try { await camVideo.play(); } catch {}

      const ready = () => new Promise(r => {
        const chk = () => { if (camVideo.videoWidth > 0 && camVideo.videoHeight > 0 && camVideo.readyState >= 2) r(); else setTimeout(chk, 80); };
        chk();
      });
      await ready();

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });

      let useBD = 'BarcodeDetector' in window;
      let detector = null;
      if (useBD) { try { detector = new BarcodeDetector({ formats: ['qr_code'] }); } catch { useBD = false; } }

      // UI bottom sheet
      const qrSheet = document.getElementById('qrSheet');
      const qrURL = document.getElementById('qrURL');
      const openLink = document.getElementById('openLink');
      const dismissSheet = document.getElementById('dismissSheet');

      function showSheet(url) {
        qrURL.textContent = url;
        openLink.href = url; // anchor target="_blank" rel="noopener"
        qrSheet.style.display = 'block';
        prompting = true; // t·∫°m d·ª´ng loop
      }
      function hideSheet() {
        qrSheet.style.display = 'none';
        prompting = false;
        coolDown = true; setTimeout(() => coolDown = false, 1200);
      }
      dismissSheet.addEventListener('click', hideSheet);

      let lastContent = '', coolDown = false, prompting = false;

      function isValidURL(t) { try { const u = new URL(t); return u.protocol === 'http:' || u.protocol === 'https:'; } catch { return false; } }

      async function loop() {
        try {
          // Ch·ªâ qu√©t khi ƒëang ·ªü ch·∫ø ƒë·ªô QR v√† kh√¥ng b√°m marker
          if (window.MODE === 'QR' && window.activeTargets === 0 && !coolDown && !prompting) {
            let foundUrl = null;
            if (useBD && detector) {
              const codes = await detector.detect(camVideo);
              if (codes && codes.length) {
                const raw = (codes[0].rawValue || '').trim();
                if (raw && raw !== lastContent && isValidURL(raw)) foundUrl = raw;
              }
            } else {
              const vw = camVideo.videoWidth | 0, vh = camVideo.videoHeight | 0;
              if (vw && vh) {
                canvas.width = vw; canvas.height = vh;
                ctx.drawImage(camVideo, 0, 0, vw, vh);
                const img = ctx.getImageData(0, 0, vw, vh);
                const qr = jsQR(img.data, vw, vh, { inversionAttempts: 'attemptBoth' });
                if (qr && qr.data) {
                  const raw = qr.data.trim();
                  if (raw && raw !== lastContent && isValidURL(raw)) foundUrl = raw;
                }
              }
            }
            if (foundUrl) {
              lastContent = foundUrl;
              showSheet(foundUrl); // ƒë·ªÉ ng∆∞·ªùi d√πng b·∫•m m·ªü tab (gesture h·ª£p l·ªá)
            }
          }
        } catch (_) {}
        setTimeout(() => requestAnimationFrame(loop), 34);
      }
      loop();
    })();
  </script>
</body>

</html>
