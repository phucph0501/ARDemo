<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>AR Video ‚Äî Ch·ªß ƒë·ªÅ A80 Qu·ªëc kh√°nh 2/9</title>

  <!-- A-Frame + MindAR (CDN) -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    /* ====== N·ªÄN TRONG SU·ªêT + CAMERA FEED ====== */
    html, body { margin:0; padding:0; height:100%; background:transparent !important;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    a-scene, canvas { background:transparent !important; }
    /* MindAR s·∫Ω ch√®n video#mindar-video ‚Äî ta ƒë∆∞a n√≥ l√†m n·ªÅn */
    video#mindar-video{
      position:fixed !important; inset:0 !important;
      width:100vw !important; height:100vh !important; object-fit:cover !important;
      z-index:-1 !important;
      filter: saturate(1.05) contrast(1.05); /* nh·∫π cho m√†u ƒë·∫πp h∆°n */
    }

    /* ====== CH·ª¶ ƒê·ªÄ A80 ‚Äî QU·ªêC KH√ÅNH 2/9 ====== */
    :root{
      --red:#C8102E;      /* ƒê·ªè c·ªù */
      --bright-red:#e11d2f;
      --gold:#FFD700;     /* V√†ng sao */
      --cream:#fff7d6;    /* V√†ng kem nh·∫π d√πng cho vi·ªÅn */
      --glass: rgba(0,0,0,.35);
    }

    /* Banner tr√™n c√πng */
    .banner{
      position:fixed; left:12px; right:12px; top:12px; z-index:10;
      display:flex; align-items:center; gap:10px;
      background: linear-gradient(135deg, var(--red), var(--bright-red));
      color:#fff; padding:10px 14px; border-radius:16px;
      box-shadow: 0 12px 30px rgba(200,16,46,.35), inset 0 0 0 2px rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
    }
    .banner .star{
      width:28px; height:28px; background:var(--gold); clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.25));
    }
    .banner .title{
      font-weight:900; letter-spacing:.2px; font-size:16px;
      text-shadow:0 1px 0 rgba(0,0,0,.25);
    }
    .banner .sub{
      margin-left:auto; font-weight:700; background:rgba(255,255,255,.15);
      padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.2);
    }

    /* V√πng ƒëi·ªÅu khi·ªÉn n√∫t */
    #ui{
      position:fixed; left:0; right:0; bottom:14px; z-index:10;
      display:flex; justify-content:center; gap:10px; padding:0 12px;
    }
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:10px 14px; border-radius:999px; font-weight:800;
      box-shadow: 0 10px 24px rgba(0,0,0,.25), inset 0 0 0 2px rgba(255,255,255,.22);
      transition:.2s transform ease, .2s filter ease;
      backdrop-filter: blur(8px);
    }
    .btn:active{ transform: translateY(2px) scale(.98); }
    .btn-gold{ background:linear-gradient(135deg, var(--gold), #f6c105); color:#7a5200; }
    .btn-silver{ background:linear-gradient(135deg, #f4f4f5, #d4d4d8); color:#111827; }
    .btn-red{ background:linear-gradient(135deg, var(--bright-red), #b4061a); color:#fff; }

    /* Tip b√°n trong su·ªët ·ªü gi·ªØa tr√™n */
    .tip{
      position:fixed; left:50%; transform:translateX(-50%);
      top:64px; z-index:10; color:#fff; font-weight:700;
      background:var(--glass); padding:8px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.2);
      text-shadow:0 1px 0 rgba(0,0,0,.35);
    }

    /* Huy hi·ªáu sao n·ªÅn m·ªù (watermark) */
    .wm-star{
      position:fixed; right:8px; bottom:88px; width:64px; height:64px; opacity:.18; z-index:1;
      background:var(--gold);
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      filter: blur(.4px);
      animation: float 6s ease-in-out infinite;
    }
    @keyframes float{ 0%{ transform:translateY(0);} 50%{ transform:translateY(-6px);} 100%{ transform:translateY(0);} }

    /* Ph√°o hoa ƒë∆°n gi·∫£n */
    .fw{
      pointer-events:none; position:fixed; inset:0; z-index:0; overflow:hidden;
    }
    .fw i{
      position:absolute; width:6px; height:6px; background:var(--gold);
      border-radius:50%; box-shadow:0 0 10px var(--gold);
      animation: pop 1200ms ease-out forwards;
    }
    @keyframes pop{
      0%{ transform:translate(0,0) scale(0); opacity:0; }
      10%{ opacity:1; }
      100%{ transform:translate(var(--x), var(--y)) scale(0.1); opacity:0; }
    }
  </style>
</head>
<body>

  <!-- Banner L·ªÖ -->
  <div class="banner">
    <div class="star"></div>
    <div class="title">M·ª´ng Qu·ªëc kh√°nh 2/9</div>
    <div class="sub">A80 Fest</div>
  </div>

  <!-- G·ª£i √Ω -->
  <div class="tip">ƒê∆∞a camera t·ªõi ·∫£nh m·ª•c ti√™u ƒë·ªÉ ph√°t video ‚Ä¢ Qu√©t QR s·∫Ω h·ªèi m·ªü tab</div>

  <!-- Huy hi·ªáu sao n·ªÅn -->
  <div class="wm-star"></div>
  <!-- L·ªõp ph√°o hoa -->
  <div class="fw" id="fw"></div>

  <!-- N√∫t ƒëi·ªÅu khi·ªÉn -->
  <div id="ui">
    <button class="btn btn-gold" id="unmuteBtn">üîä B·∫≠t ti·∫øng</button>
    <button class="btn btn-silver" id="flashBtn">‚ö° ƒê·ªïi camera (n·∫øu c·∫ßn)</button>
    <button class="btn btn-red" id="celeBtn">üéÜ Ch√∫c m·ª´ng</button>
  </div>

  <!-- ===== AR Scene ===== -->
  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    embedded
    renderer="alpha: true; colorManagement: true; physicallyCorrectLights: true">

    <a-assets>
      <!-- ƒê·ªîI ƒë∆∞·ªùng d·∫´n cho ph√π h·ª£p. C√≥ th·ªÉ tr·ªè CDN/Drive (uc?export=download&id=...) -->
      <video id="v0" src="./video1.mp4" preload="auto" webkit-playsinline playsinline crossorigin="anonymous"></video>
      <video id="v1" src="./video2.mp4" preload="auto" webkit-playsinline playsinline crossorigin="anonymous"></video>
      <video id="v2" src="./video3.mp4" preload="auto" webkit-playsinline playsinline crossorigin="anonymous"></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- targetIndex ph·∫£i ƒë√∫ng th·ª© t·ª± ·∫£nh trong targets.mind -->
    <a-entity id="t0" mindar-image-target="targetIndex: 0">
      <a-video src="#v0" width="1" height="0.5625" position="0 0 0"></a-video>
    </a-entity>

    <a-entity id="t1" mindar-image-target="targetIndex: 1">
      <a-video src="#v1" width="1" height="0.5625" position="0 0 0"></a-video>
    </a-entity>

    <a-entity id="t2" mindar-image-target="targetIndex: 2">
      <a-video src="#v2" width="1" height="0.5625" position="0 0 0"></a-video>
    </a-entity>

  </a-scene>

  <script>
    /* ====== N√öT & √ÇM THANH ====== */
    const vids = Array.from(document.querySelectorAll('video'));
    const unmuteBtn = document.getElementById('unmuteBtn');
    vids.forEach(v=>{
      v.muted = true; v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
    });
    unmuteBtn.addEventListener('click', ()=>{
      vids.forEach(v=> v.muted=false);
      vids.forEach(v=> v.play().catch(()=>{}));
      unmuteBtn.disabled = true; unmuteBtn.textContent = "üîä ƒê√£ b·∫≠t";
    });
    document.body.addEventListener('touchstart', ()=>{ vids.forEach(v=>v.play().catch(()=>{})); }, {once:true});

    /* ====== THEO D√ïI MARKER ‚Üí PH√ÅT/D·ª™NG VIDEO ====== */
    let activeTargets = 0;
    function wireTarget(tId, vId){
      const t = document.getElementById(tId);
      const v = document.getElementById(vId);
      if(!t || !v) return;
      t.addEventListener('targetFound', ()=>{
        activeTargets++;
        try{ if(v.currentTime<0.01) v.currentTime=0; }catch{}
        v.play().catch(()=>{});
      });
      t.addEventListener('targetLost', ()=>{
        activeTargets = Math.max(0, activeTargets-1);
        if(!v.paused) v.pause();
      });
    }
    wireTarget('t0','v0'); wireTarget('t1','v1'); wireTarget('t2','v2');

    /* ====== QU√âT QR (chung camera MindAR) ====== */
    (async ()=>{
      // ƒë·ª£i MindAR g·∫Øn video n·ªÅn
      const waitMindARVideo = () => new Promise(res=>{
        const f=()=>{ const v=document.getElementById('mindar-video'); v?res(v):requestAnimationFrame(f); }; f();
      });
      const camVideo = await waitMindARVideo();

      if(!('BarcodeDetector' in window)){
        console.warn('Thi·∫øu BarcodeDetector (c·∫ßn Chrome/Edge m·ªõi, iOS 17+).');
        return;
      }
      const detector = new BarcodeDetector({formats:['qr_code']});
      let lastContent=''; let coolDown=false; let prompting=false;

      function isValidURL(txt){ try{ const u=new URL(txt); return ['http:','https:'].includes(u.protocol); }catch{ return false; } }

      async function loop(){
        try{
          if(activeTargets===0 && !coolDown && !prompting){
            const codes = await detector.detect(camVideo);
            if(codes && codes.length){
              const raw = (codes[0].rawValue||'').trim();
              if(raw && raw!==lastContent && isValidURL(raw)){
                prompting = true;
                const ok = window.confirm('Ph√°t hi·ªán QR:\\n'+raw+'\\n\\nM·ªü tab m·ªõi?');
                if(ok){ window.open(raw, '_blank', 'noopener'); }
                lastContent=raw; coolDown=true; setTimeout(()=>coolDown=false, 1500); prompting=false;
              }
            }
          }
        }catch(_){}
        requestAnimationFrame(loop);
      }
      loop();
    })();

    /* ====== PH√ÅO HOA L·ªÑ ====== */
    const fw = document.getElementById('fw');
    function fireworkBurst(x,y){
      for(let i=0;i<22;i++){
        const p=document.createElement('i');
        const ang=Math.random()*Math.PI*2, r=60+Math.random()*140;
        p.style.left=x+'px'; p.style.top=y+'px';
        p.style.setProperty('--x', Math.cos(ang)*r+'px');
        p.style.setProperty('--y', Math.sin(ang)*r+'px');
        fw.appendChild(p);
        setTimeout(()=>p.remove(), 1200);
      }
    }
    const celeBtn=document.getElementById('celeBtn');
    celeBtn.addEventListener('click', ()=>{
      const cx=innerWidth/2, cy=innerHeight*0.35;
      fireworkBurst(cx, cy);
      setTimeout(()=>fireworkBurst(cx-90, cy+40), 120);
      setTimeout(()=>fireworkBurst(cx+90, cy+20), 220);
      if(navigator.vibrate) navigator.vibrate(80);
    });

    /* ====== ƒê·ªîI CAMERA (n·∫øu thi·∫øt b·ªã h·ªó tr·ª£) ======
       MindAR ch∆∞a expose API ƒë·ªïi facingMode tr·ª±c ti·∫øp trong runtime ·ªïn ƒë·ªãnh tr√™n m·ªçi tr√¨nh duy·ªát.
       N√∫t n√†y g·ª£i √Ω ng∆∞·ªùi d√πng l√†m m·ªõi trang; tr√™n m·ªôt s·ªë m√°y s·∫Ω t·ª± ch·ªçn camera sau khi reload. */
    document.getElementById('flashBtn').addEventListener('click', ()=>{
      alert('N·∫øu camera tr∆∞·ªõc/sau ch∆∞a ƒë√∫ng, h√£y xoay thi·∫øt b·ªã ho·∫∑c t·∫£i l·∫°i trang.\nMindAR s·∫Ω ch·ªçn camera ph√π h·ª£p (th∆∞·ªùng l√† camera sau).');
    });
  </script>
</body>
</html>
