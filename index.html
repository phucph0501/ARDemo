<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>AR Video ‚Äî Ch·ªß ƒë·ªÅ A80 Qu·ªëc kh√°nh 2/9</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <!-- jsQR fallback cho qu√©t QR -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: transparent !important;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    a-scene,
    canvas {
      background: transparent !important;
    }

    video#mindar-video {
      position: fixed !important;
      inset: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      object-fit: cover !important;
      z-index: -1 !important;
      filter: saturate(1.05) contrast(1.05);
    }

    :root {
      --red: #C8102E;
      --bright-red: #e11d2f;
      --gold: #FFD700;
      --glass: rgba(0, 0, 0, .35);
    }

    .banner {
      position: fixed;
      left: 12px;
      right: 12px;
      top: 12px;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(135deg, var(--red), var(--bright-red));
      color: #fff;
      padding: 10px 14px;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(200, 16, 46, .35), inset 0 0 0 2px rgba(255, 255, 255, .12);
      backdrop-filter: blur(8px);
    }

    .banner .star {
      width: 28px;
      height: 28px;
      background: var(--gold);
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, .25));
    }

    .banner .title {
      font-weight: 900;
      letter-spacing: .2px;
      font-size: 16px;
      text-shadow: 0 1px 0 rgba(0, 0, 0, .25);
    }

    .banner .sub {
      margin-left: auto;
      font-weight: 700;
      background: rgba(255, 255, 255, .15);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .2);
    }

    .tip {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      top: 64px;
      z-index: 10;
      color: #fff;
      font-weight: 700;
      background: var(--glass);
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .2);
      text-shadow: 0 1px 0 rgba(0, 0, 0, .35);
    }

    #ui {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 14px;
      z-index: 10;
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 0 12px;
    }

    .btn {
      appearance: none;
      border: 0;
      cursor: pointer;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 800;
      box-shadow: 0 10px 24px rgba(0, 0, 0, .25), inset 0 0 0 2px rgba(255, 255, 255, .22);
      backdrop-filter: blur(8px);
      background: linear-gradient(135deg, var(--gold), #f6c105);
      color: #7a5200;
    }
  </style>
</head>

<body>

  <div class="banner">
    <div class="star"></div>
    <div class="title">M·ª´ng Qu·ªëc kh√°nh 2/9</div>
    <div class="sub">A80 Fest</div>
  </div>

  <div class="tip" id="tip">Nh·∫•n n√∫t ƒë·ªÉ chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô AR/QR</div>

  <div id="ui">
    <button class="btn" id="modeBtn">üîÅ Ch·∫ø ƒë·ªô: AR</button>
  </div>

  <a-scene mindar-image="imageTargetSrc: ./targets.mind;" vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false" embedded
    renderer="alpha: true; colorManagement: true; physicallyCorrectLights: true">

    <a-assets>
      <video id="v0" src="./video1.mp4" preload="auto" webkit-playsinline playsinline crossorigin="anonymous"></video>
      <video id="v1" src="./video2.mp4" preload="auto" webkit-playsinline playsinline crossorigin="anonymous"></video>
      <video id="v2" src="./video3.mp4" preload="auto" webkit-playsinline playsinline crossorigin="anonymous"></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity id="t0" mindar-image-target="targetIndex: 0">
      <a-video src="#v0" width="1" height="0.5625" position="0 0 0"></a-video>
    </a-entity>
    <a-entity id="t1" mindar-image-target="targetIndex: 1">
      <a-video src="#v1" width="1" height="0.5625" position="0 0 0"></a-video>
    </a-entity>
    <a-entity id="t2" mindar-image-target="targetIndex: 2">
      <a-video src="#v2" width="1" height="0.5625" position="0 0 0"></a-video>
    </a-entity>

  </a-scene>

  <script>
    /* ===== c·∫•u h√¨nh chung ===== */
    const vids = Array.from(document.querySelectorAll('video'));
    vids.forEach(v => { v.muted = true; v.setAttribute('playsinline', ''); v.setAttribute('webkit-playsinline', ''); });
    // B·∫≠t ti·∫øng sau l·∫ßn ch·∫°m ƒë·∫ßu ti√™n (iOS/Android c·∫ßn user gesture)
    function enableAudioOnce() {
      vids.forEach(v => {
        v.muted = false;
        v.play().catch(() => { }); // iOS c·∫ßn g·ªçi play() sau khi unmute
      });
    }
    window.addEventListener('touchend', enableAudioOnce, { once: true });
    window.addEventListener('click', enableAudioOnce, { once: true });


    // Ch·∫ø ƒë·ªô: 'AR' ho·∫∑c 'QR'
    window.MODE = 'AR';
    const modeBtn = document.getElementById('modeBtn');
    const tipEl = document.getElementById('tip');
    modeBtn.addEventListener('click', () => {
      window.MODE = (window.MODE === 'AR') ? 'QR' : 'AR';
      if (window.MODE === 'AR') {
        vids.forEach(v => { v.muted = false; v.play().catch(() => { }); });
      }
      modeBtn.textContent = (window.MODE === 'AR') ? 'üîÅ Ch·∫ø ƒë·ªô: AR' : 'üîÅ Ch·∫ø ƒë·ªô: QR';
      tipEl.textContent = (window.MODE === 'AR')
        ? 'Nh·∫•n n√∫t ƒë·ªÉ qu√©t QR'
        : 'Nh·∫•n n√∫t ƒë·ªÉ v·ªÅ ch·∫ø ƒë·ªô AR';
      // khi v√†o QR mode: d·ª´ng h·∫øt video
      if (window.MODE === 'QR') vids.forEach(v => { try { v.pause(); } catch { } });
    });

    /* ===== theo d√µi marker ===== */
    window.activeTargets = 0;
    function wireTarget(targetSelector, videoSelector) {
      const target = document.querySelector(targetSelector);
      const video = document.querySelector(videoSelector);
      if (!target || !video) return;

      target.addEventListener('targetFound', () => {
        window.activeTargets++;
        if (window.MODE === 'AR') {        // ch·ªâ ph√°t khi ·ªü AR mode
          try { if (video.currentTime < 0.01) video.currentTime = 0; } catch { }
          video.play().catch(() => { });
        }
      });
      target.addEventListener('targetLost', () => {
        window.activeTargets = Math.max(0, window.activeTargets - 1);
        if (!video.paused) video.pause();
      });
    }
    wireTarget('#t0', '#v0');
    wireTarget('#t1', '#v1');
    wireTarget('#t2', '#v2');

    /* ===== qu√©t QR (d√πng camera MindAR) ===== */
    (async () => {
      function findMindARVideo() {
        // ∆Øu ti√™n ph·∫ßn t·ª≠ c√≥ stream camera th·∫≠t
        const all = Array.from(document.querySelectorAll('video'));
        const withStream = all.find(v => v.srcObject instanceof MediaStream);
        if (withStream) return withStream;

        // MindAR th∆∞·ªùng ƒë·∫∑t id b·∫Øt ƒë·∫ßu b·∫±ng 'mindar'
        const byId = document.querySelector('video#mindar-video')
          || document.querySelector('video#mindar-image-video')
          || all.find(v => (v.id || '').includes('mindar'));
        return byId || null;  // KH√îNG tr·∫£ v·ªÅ video th∆∞·ªùng n·ªØa
      }

      const waitMindARVideo = () => new Promise(res => {
        const tick = () => { const v = findMindARVideo(); v ? res(v) : requestAnimationFrame(tick); }; tick();
      });
      const camVideo = await waitMindARVideo();
      camVideo.setAttribute('playsinline', ''); camVideo.setAttribute('webkit-playsinline', '');
      try { await camVideo.play(); } catch { }

      const ready = () => new Promise(r => {
        const chk = () => { if (camVideo.videoWidth > 0 && camVideo.videoHeight > 0 && camVideo.readyState >= 2) r(); else setTimeout(chk, 80); };
        chk();
      });
      await ready();

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });

      let useBD = 'BarcodeDetector' in window;
      let detector = null;
      if (useBD) { try { detector = new BarcodeDetector({ formats: ['qr_code'] }); } catch { useBD = false; } }

      let lastContent = '', coolDown = false, prompting = false;
      const toast = document.createElement('div');
      toast.textContent = useBD ? 'QR: d√πng BarcodeDetector' : 'QR: d√πng ch·∫ø ƒë·ªô t∆∞∆°ng th√≠ch (jsQR)';
      Object.assign(toast.style, { position: 'fixed', bottom: '86px', left: '12px', background: 'rgba(0,0,0,.5)', color: '#fff', padding: '6px 10px', borderRadius: '10px', fontSize: '12px', zIndex: 20 });
      document.body.appendChild(toast); setTimeout(() => toast.remove(), 2500);

      function isValidURL(t) { try { const u = new URL(t); return u.protocol === 'http:' || u.protocol === 'https:'; } catch { return false; } }
      function maybeOpen(url) {
        if (!url || prompting) return;
        prompting = true;
        const ok = window.confirm('Ph√°t hi·ªán QR:\n' + url + '\n\nB·∫°n c√≥ mu·ªën m·ªü ·ªü tab m·ªõi kh√¥ng?');
        if (ok) window.open(url, '_blank', 'noopener');
        lastContent = url; coolDown = true; setTimeout(() => coolDown = false, 1500); prompting = false;
      }

      async function loop() {
        try {
          // Ch·ªâ qu√©t khi ƒëang ·ªü ch·∫ø ƒë·ªô QR v√† kh√¥ng b√°m marker
          if (window.MODE === 'QR' && window.activeTargets === 0 && !coolDown && !prompting) {
            let foundUrl = null;
            if (useBD && detector) {
              const codes = await detector.detect(camVideo);
              if (codes && codes.length) {
                const raw = (codes[0].rawValue || '').trim();
                if (raw && raw !== lastContent && isValidURL(raw)) foundUrl = raw;
              }
            } else {
              const vw = camVideo.videoWidth | 0, vh = camVideo.videoHeight | 0;
              if (vw && vh) {
                canvas.width = vw; canvas.height = vh;
                ctx.drawImage(camVideo, 0, 0, vw, vh);
                const img = ctx.getImageData(0, 0, vw, vh);
                const qr = jsQR(img.data, vw, vh, { inversionAttempts: 'attemptBoth' });
                if (qr && qr.data) {
                  const raw = qr.data.trim();
                  if (raw && raw !== lastContent && isValidURL(raw)) foundUrl = raw;
                }
              }
            }
            if (foundUrl) maybeOpen(foundUrl);
          }
        } catch (_) { }
        setTimeout(() => requestAnimationFrame(loop), 34);
      }
      loop();
    })();
  </script>
</body>

</html>